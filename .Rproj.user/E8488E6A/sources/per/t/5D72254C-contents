path = "C:/Users/kabaldry/OneDrive - University of Tasmania/Documents/Projects/BIO-MATE/BIO-MATE.v0/reformatted_data"


library(data.table)
library(dplyr)

compile_pigments <- function(path, ex.list = NULL){
  
    # profiling sensor path
    ctd_path =file.path(path,"profiling_sensors")
    # pigment path
    file_path = file.path(path,"pigments")
    # read in files
    files = list.files(path = file_path,pattern = ".csv",full.names = T)
    #files = files[!grepl("_layer.csv",files)]
    if(!is.null(ex.list)){
      files = files[grepl(paste(ex.list,sep = "|",collapse = "|"),files)]
    }
    
    for(fl in files){
      
      # grab header data
      f <- file(fl, open = "r" )
      n=0
      while( TRUE ){
        n = n+1
        line <- readLines( f, 1L )
        if( grepl( "EXPOCODE =", line ) ){
          ex <- trimws(sub("EXPOCODE =", "", line ))
        }
        if( grepl( "#ANALYSIS_METHOD:", line ) ){
          mt <- trimws(sub("#ANALYSIS_METHOD:", "", line ))
        }
        if( grepl( "#SOURCED_FROM:", line ) ){
          sc <- trimws(sub("#SOURCED_FROM:", "", line ))
        }
        if(grepl("CTD_IDs | DATE | TIME_s | TIME_b| TIME_e | LATITUDE", line)){break}
      }
      close( f )
      
      # load file data
      file_data = as.data.frame(fread(fl,strip.white = T , stringsAsFactors = F, skip = n+1,na.strings =  "-999"))
      f_headers = as.character(fread(fl,stringsAsFactors = F, skip = n-1, nrows = 1, header = F))
      colnames(file_data) = f_headers
      # add header data
      file_data$PIG_SOURCE = sc
      file_data$PIG_METHOD = mt
      file_data$EXPOCODE = ex
      if(!exists("data",inherits = F)){data = file_data}else{
        # append file data
        data = rbind(data,file_data)
      }
      
      rm(file_data)
      print(paste(fl,"compiled"))
    }
    
    # All pigment names
#    pig_names = colnames(data)[-c(1:which(colnames(data) == "DEPTH"),which(colnames(data) == "PIG_SOURCE"):length(colnames(data)))]
    
    ### Remove rows that have no depth info and haven't been flagged as Underway measurements ###
    #data = data %>% filter(!(data$CTD_IDs != "U" & is.na(as.numeric(DEPTH))))
    
    ### Remove rows that have no pigment information ###
   # data = data[unlist(lapply(1:nrow(data), function(x){any(!is.na(data[x,pig_names]))})),]
    
    return(data)
}

