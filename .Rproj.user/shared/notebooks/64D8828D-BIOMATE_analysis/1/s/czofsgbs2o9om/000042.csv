"0"," t_thresh = 6"
"0"," d_thresh = 1000"
"0","  # this small function prevents the drop of midnight 00:00:00"
"0","  calc.dist.min = function(x){"
"0","   mins = which.min(distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[,c(""LON"",""LAT"")])))[1]"
"0","   dists = distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[mins,c(""LON"",""LAT"")]))"
"0","   if(any(!is.na(CTD_df$LON_b))){"
"0","     minb = which.min(distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[,c(""LON_b"",""LAT_b"")])))[1]"
"0","     mins = c(mins, minb)"
"0","     distb = distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[minb,c(""LON_b"",""LAT_b"")]))"
"0","     dists = c(dists, distb)}"
"0","   if(any(!is.na(CTD_df$LON_e))){"
"0","     mine = which.min(distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[,c(""LON_e"",""LAT_e"")])))[1]"
"0","     mins = c(mins, mine)"
"0","     diste = distGeo(c(unmatched_df_p$LON_analyser[x], unmatched_df_p$LAT_analyser[x]), as.matrix(CTD_df[mine,c(""LON_e"",""LAT_e"")]))"
"0","     dists = c(dists, diste)}"
"0","     data.frame(min = mins[which.min(dists)],diff = dists[which.min(dists)])"
"0","     }"
"0","  #calc.dist.diff = function(x){distGeo(c(unmatched_df_p$LON[x], unmatched_df_p$LAT[x]), as.matrix(CTD_df[unmatched_df_p$dist_min[x],c(""LON"",""LAT"")]))}"
"0","  calc.time.min = function(x){which.min(abs(unlist(lapply(col_t, FUN = function(y){difftime(CTD_df[,y], unmatched_df_t$time_m[x], units = ""secs"")}))))[1]}"
"0","  calc.time.diff =  function(x){abs(unlist(lapply(col_t, FUN = function(y){difftime(CTD_df[,y], unmatched_df_t$time_m[x], units = ""secs"")})))[unmatched_df_t$closest_t[x]]}"
"0","# CTD data exists?. Closest position and closest times?"
"0","pig_data$PROF_data = NA"
"0","pig_data$d_diff = NA"
"0","pig_data$t_diff = NA"
"0","for(ex in pig_expos){"
"0","    sub_prof_files = prof_files[which(substr(prof_files,1,12) == ex)]"
"0","    sub_pig_data = pig_data %>% filter(EXPOCODE == ex) %>% mutate(STNCAST = paste(STNNBR_analyser,CASTNO_analyser))"
"0","    data2_stncast = paste(sub_pig_data$STNNBR_analyser,sub_pig_data$CASTNO_analyser)"
"0","    sub_pig_data = sub_pig_data[!duplicated(sub_pig_data$STNCAST),]"
"0","    "
"0","    pig_data$PROF_data[which(pig_data$EXPOCODE == ex)] = length(sub_prof_files) != 0"
"0","    CTD_df_sub = CTD_df %>% filter(substr(prof_files,1,12) == ex)"
"0","    "
"0","    if(length(sub_prof_files) > 0){"
"0","      # ctd_ids from CTD files"
"0","      CTD_IDs = unlist(strsplit(sub_prof_files,""_ctd1.csv""))"
"0","      # create a data frame with split info"
"0","      ctd_split = strsplit(CTD_IDs, split = ""_"")"
"0","      CTD_info = data.frame(""CTD_ID"" = CTD_IDs, ""EXPOCODE"" = sapply(ctd_split, ""[["", 1), ""STNNBR"" = sapply(ctd_split, ""[["", 3), ""CASTNO""= sapply(ctd_split, ""[["", 4), stringsAsFactors = F)"
"0","  "
"0","      unmatched_df_t = sub_pig_data %>% filter(!is.na(TIME_analyser), !is.empty(TIME_analyser), !is.empty(DATE_analyser)) "
"0","      unmatched_df_t = unmatched_df_t[,c(1:64,67)] %>%"
"0","        mutate(time_m = as.POSIXct(paste(DATE_analyser,TIME_analyser), format = ""%Y-%m-%d %H:%M:%S"", tz = ""UTC""))"
"0","      notime = ifelse(nrow(unmatched_df_t) == 0,T,F)"
"0","      unmatched_df_p = sub_pig_data %>% filter(!is.na(LAT_analyser))"
"0","      unmatched_df_p = unmatched_df_p[,c(1:64,67)]"
"0","      nopos = ifelse(nrow(unmatched_df_p) == 0,T,F)"
"0","      if(!nopos){"
"0","        ### match closest times"
"0","        col_t = c(3:5)[!colSums(is.na(CTD_df_sub[3:5])) == nrow(CTD_df_sub)]"
"0","        if(!notime){"
"0","        #calculate time differences"
"0","        unmatched_df_t$closest_t = unlist(lapply(1:nrow(unmatched_df_t), calc.time.min))"
"0","        unmatched_df_t$t_diff = unlist(lapply(1:nrow(unmatched_df_t), calc.time.diff))"
"0","          # check it is within 3 hours and assign CTD_ID"
"0","          unmatched_df_t = unmatched_df_t %>% filter(!is.na(closest_t), t_diff < t_thresh)"
"0","          # Any matches?"
"0","          if(nrow(unmatched_df_t) > 0){"
"0","            # get CTD_IDs"
"0","            unmatched_df_t$CTD_ID = unlist(lapply(1:nrow(unmatched_df_t),function(x){r = CTD_df_sub$CTD_ID[unmatched_df_t$closest_t[x]%%nrow(CTD_df_sub)]"
"0","            if(is.empty(r)){r = CTD_df_sub$CTD_ID[nrow(CTD_df_sub)]}"
"0","            return(r)}))"
"0","            # join with data 2 IDs"
"0","            joined_t = left_join(data.frame(""STNCAST"" = data2_stncast),unmatched_df_t , by = ""STNCAST"")"
"0","          }}"
"0","        ### match closest positions"
"0","        # match with closest lat/lon on same date"
"0","        d_calc = lapply(1:nrow(unmatched_df_p), calc.dist.min)"
"0","        unmatched_df_p$dist_min  = unlist(lapply(d_calc,""["",""min""))"
"0","        unmatched_df_p$d_diff = unlist(lapply(d_calc,""["",""diff""))"
"0","        # check within distance threshold"
"0","        #unmatched_df_p  = unmatched_df_p %>% filter(d_diff < d_thresh)"
"0","        # Any matches?"
"0","        if(nrow(unmatched_df_p) > 0 & notime){"
"0","          # if no time matches consider date of position matches."
"0","            unmatched_df_p = unmatched_df_p %>% mutate(Date_match = ifelse(DATE_analyser == CTD_df_sub$DATE[dist_min],T,F))"
"0","            unmatched_df_p = unmatched_df_p %>% filter(Date_match)"
"0","          }"
"0","        if(nrow(unmatched_df_p) > 0){"
"0","          # get CTD_ID"
"0","          unmatched_df_p$CTD_ID = unlist(lapply(1:nrow(unmatched_df_p),function(x){CTD_df_sub$CTD_ID[unmatched_df_p$dist_min[x]]}))"
"0","          # join with data 2 IDs"
"0","          joined_p = left_join(data.frame(""STNCAST"" = data2_stncast),unmatched_df_p[,64:65] , by = c(""STNCAST""))"
"0","          if(exists(""joined_t"")){"
"0","           # join with data 2 IDs"
"0","           ## needs unique join columns. need to check if OK in PIG_to_WHPE"
"0","          joined_t_p = left_join(joined_t,unmatched_df_p[,c(""STNCAST"",""dist_min"",""d_diff"")] , by = ""STNCAST"")"
"0","          rm(joined_t)"
"0","          }else{joined_t_p = joined_p"
"0","          rm(joined_p)}"
"0","          }"
"0","             "
"0","      if(any(grepl(pattern = ""d_diff"", colnames(joined_t_p)))){"
"0","        pig_data$d_diff[pig_data$EXPOCODE == ex] = joined_t_p$d_diff"
"0","      }  "
"0","      if(any(grepl(pattern = ""t_diff"", colnames(joined_t_p)))){"
"0","        pig_data$t_diff[pig_data$EXPOCODE == ex] = joined_t_p$t_diff}"
"0","        rm(joined_t_p)"
"0","}}}"
"2","Error in colnames(joined_t_p) : object 'joined_t_p' not found
"
